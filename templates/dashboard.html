{% extends "base.html" %}

{% block title %}Dashboard - GestÃ£o Financeira{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>ðŸ’° GestÃ£o Financeira</h1>
        <div>
            <span style="margin-right: 20px; color: #666;">OlÃ¡, {{ session.user_name }}!</span>
            <a href="{{ url_for('logout') }}" class="btn btn-small btn-danger">Sair</a>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Month Filter -->
    <div class="card" style="margin-bottom: 20px;">
        <form method="GET" action="{{ url_for('dashboard') }}" style="display: flex; align-items: center; gap: 15px;">
            <label for="month_filter" style="font-weight: 500; color: #555;">Filtrar por MÃªs:</label>
            <input type="month" id="month_filter" name="month" value="{{ selected_month }}" 
                   onchange="this.form.submit()" 
                   style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <span style="color: #667eea; font-weight: 500;">{{ selected_month }}</span>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card">
            <h3>Receita Mensal</h3>
            <div class="value value-positive">R$ {{ "%.2f"|format(summary.total_income) }}</div>
        </div>

        <div class="summary-card">
            <h3>Despesa Mensal</h3>
            <div class="value {% if summary.total_monthly_expenses <= summary.total_income %}value-warning{% else %}value-negative{% endif %}">
                R$ {{ "%.2f"|format(summary.total_monthly_expenses) }}
            </div>
        </div>

        <div class="summary-card">
            <h3>Total de Despesas</h3>
            <div class="value {% if summary.total_expenses <= summary.total_income %}value-positive{% else %}value-yellow{% endif %}">R$ {{ "%.2f"|format(summary.total_expenses) }}</div>
        </div>

        <div class="summary-card">
            <h3>Despesa Semanal</h3>
            <div class="value {% if summary.total_weekly_expenses > (summary.total_income * 0.25) %}value-warning{% else %}value-primary{% endif %}">R$ {{ "%.2f"|format(summary.total_weekly_expenses) }}</div>
        </div>

        <div class="summary-card">
            <h3>Saldo Mensal</h3>
            <div class="value {% if summary.balance >= 0 %}value-positive{% else %}value-negative{% endif %}">
                R$ {{ "%.2f"|format(summary.balance) }}
            </div>
        </div>

        <div class="summary-card">
            <h3>% Utilizado</h3>
            <div class="value value-primary">{{ summary.percentage_used }}%</div>
        </div>

        <div class="summary-card">
            <h3>% Despesas Pagas</h3>
            <div class="value value-positive">{{ summary.percentage_paid }}%</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 20px;">
        <button onclick="openModal('incomeModal')" class="btn btn-success">+ Definir Receita</button>
        <button onclick="openModal('expenseModal')" class="btn">+ Nova Despesa</button>
    </div>

    <!-- Expenses Table -->
    <div class="card">
        <h2 style="margin-bottom: 20px; color: #667eea;">Despesas</h2>
        
        {% if expenses %}
        <table>
            <thead>
                <tr>
                    <th>DescriÃ§Ã£o</th>
                    <th>Categoria</th>
                    <th>Valor Total</th>
                    <th>Parcelas</th>
                    <th>Valor/MÃªs</th>
                    <th>Valor/Semana</th>
                    <th>Vencimento</th>
                    <th>Status</th>
                    <th>Data Pagamento</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>
                        {{ expense.description }}
                        {% if expense.get('current_installment') and expense.get('current_installment') > 1 %}
                            <span style="color: #667eea; font-size: 12px;">({{ expense.current_installment }}/{{ expense.installments }})</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if expense.installments > 1 %}
                            {% if expense.get('value_type') == 'individual' %}
                                Parcelado por Semana
                            {% elif expense.get('value_type') == 'total' %}
                                Parcelado por MÃªs
                            {% else %}
                                Parcelado
                            {% endif %}
                        {% else %}
                            Sem Parcelas
                        {% endif %}
                    </td>
                    <td><strong>R$ {{ "%.2f"|format(expense.total_amount) }}</strong></td>
                    <td>{{ expense.installments }}x</td>
                    <td>
                        {% if expense.get('value_type') == 'total' %}
                            R$ {{ "%.2f"|format(expense.installment_value) }}
                        {% else %}
                            R$ {{ "%.2f"|format(expense.total_amount) }}
                        {% endif %}
                    </td>
                    <td>
                        R$ {{ "%.2f"|format(expense.installment_value / expense.installments) }}
                    </td>
                    <td>{{ expense.due_date }}</td>
                    <td>
                        <a href="{{ url_for('toggle_status', expense_id=expense.id, month=selected_month) }}" 
                           onclick="return confirm('Tem certeza que deseja marcar a despesa &quot;{{ expense.description }}&quot; como {{ 'Pendente' if expense.status == 'paid' else 'Paga' }}?')">
                            <span class="status-badge status-{{ expense.status }}">
                                {{ 'Pago' if expense.status == 'paid' else 'Pendente' }}
                            </span>
                        </a>
                    </td>
                    <td>
                        {% if expense.paid_date %}
                            {{ expense.paid_date }}
                        {% else %}
                            <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <button onclick="openEditModal({{ expense.id }}, '{{ expense.description }}', {{ expense.total_amount }}, {{ expense.installments }}, '{{ expense.get('value_type', 'total') }}', '{{ expense.due_date }}', '{{ expense.category }}', '{{ expense.month }}')" 
                                class="btn btn-small" style="margin-right: 5px;">
                            Editar
                        </button>
                        <a href="{{ url_for('duplicate_expense', expense_id=expense.id, month=selected_month) }}" 
                           class="btn btn-small" style="background: #10b981; margin-right: 5px;"
                           onclick="return confirm('Duplicar &quot;{{ expense.description }}&quot; para o prÃ³ximo mÃªs?')">
                            Duplicar
                        </a>
                        <a href="{{ url_for('delete_expense', expense_id=expense.id, month=selected_month) }}" 
                           class="btn btn-small btn-danger"
                           onclick="return confirm('Tem certeza que deseja excluir?')">
                            Excluir
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: #999; padding: 40px 0;">
            Nenhuma despesa cadastrada.<br>
            <small>Clique em "+ Nova Despesa" para comeÃ§ar</small>
        </p>
        {% endif %}
    </div>

    <!-- Income Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Definir Receita</h2>
                <span class="close-modal" onclick="closeModal('incomeModal')">&times;</span>
            </div>
            
            <form method="POST" action="{{ url_for('add_income') }}">
                <div class="form-group">
                    <label for="income_description">DescriÃ§Ã£o *</label>
                    <input type="text" id="income_description" name="description" required placeholder="Ex: SalÃ¡rio, Freelance">
                </div>

                <div class="form-group">
                    <label for="income_amount">Valor *</label>
                    <input type="number" id="income_amount" name="amount" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="income_month">MÃªs/Ano *</label>
                    <input type="month" id="income_month" name="month" required value="{{ selected_month }}" onchange="loadIncomeForMonth()">
                    <small style="color: #666; display: block; margin-top: 5px;">Altere o mÃªs para editar receita de outro perÃ­odo</small>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('incomeModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Despesa</h2>
                <span class="close-modal" onclick="closeModal('expenseModal')">&times;</span>
            </div>
            
            <form method="POST" action="{{ url_for('add_expense') }}" onsubmit="return validateExpenseForm()">
                <div class="form-group">
                    <label for="expense_description">DescriÃ§Ã£o *</label>
                    <input type="text" id="expense_description" name="description" required placeholder="Ex: Conta de luz">
                </div>

                <div class="form-group">
                    <label for="total_amount">Valor *</label>
                    <input type="number" id="total_amount" name="total_amount" step="0.01" required placeholder="0.00" oninput="calculateInstallment()">
                </div>

                <div class="form-group">
                    <label for="installments">Parcelas *</label>
                    <input type="number" id="installments" name="installments" min="1" required value="1" oninput="toggleValueTypeField()">
                </div>

                <div class="form-group" id="value_type_group" style="display: none;">
                    <label for="value_type">Tipo de Valor *</label>
                    <select id="value_type" name="value_type" onchange="calculateInstallment()">
                        <option value="">Selecione...</option>
                        <option value="total">Valor Total (serÃ¡ dividido)</option>
                        <option value="individual">Valor Individual (serÃ¡ multiplicado)</option>
                    </select>
                </div>

                <div id="installment_info" style="background: #e0e7ff; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #4338ca;"><strong>Valor Total:</strong></span>
                        <span id="total_value_display" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #4338ca;"><strong>Valor por Parcela:</strong></span>
                        <span id="installment_value" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="expense_month">MÃªs da Despesa *</label>
                    <input type="month" id="expense_month" name="expense_month" required value="{{ now.strftime('%Y-%m') }}">
                    <small style="color: #666; display: block; margin-top: 5px;">Selecione o mÃªs em que a despesa foi gerada</small>
                </div>

                <div class="form-group">
                    <label for="due_date">Data de Vencimento *</label>
                    <input type="date" id="due_date" name="due_date" required>
                    <small style="color: #666; display: block; margin-top: 5px;">Data do pagamento (normalmente no mÃªs seguinte)</small>
                </div>

                <div class="form-group">
                    <label for="category">Categoria (opcional)</label>
                    <input type="text" id="category" name="category" placeholder="Ex: Moradia, AlimentaÃ§Ã£o">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('expenseModal')">Cancelar</button>
                    <button type="submit" class="btn" style="flex: 1;">Criar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Despesa</h2>
                <span class="close-modal" onclick="closeModal('editExpenseModal')">&times;</span>
            </div>
            
            <form id="editExpenseForm" method="POST" action="">
                <div class="form-group">
                    <label for="edit_expense_description">DescriÃ§Ã£o *</label>
                    <input type="text" id="edit_expense_description" name="description" required placeholder="Ex: Conta de luz">
                </div>

                <div class="form-group">
                    <label for="edit_total_amount">Valor *</label>
                    <input type="number" id="edit_total_amount" name="total_amount" step="0.01" required placeholder="0.00" oninput="calculateEditInstallment()">
                </div>

                <div class="form-group">
                    <label for="edit_installments">Parcelas *</label>
                    <input type="number" id="edit_installments" name="installments" min="1" required value="1" oninput="toggleEditValueTypeField()">
                </div>

                <div class="form-group" id="edit_value_type_group" style="display: none;">
                    <label for="edit_value_type">Tipo de Valor *</label>
                    <select id="edit_value_type" name="value_type" required onchange="calculateEditInstallment()">
                        <option value="">Selecione...</option>
                        <option value="total">Valor Total (serÃ¡ dividido)</option>
                        <option value="individual">Valor Individual (serÃ¡ multiplicado)</option>
                    </select>
                </div>

                <div id="edit_installment_info" style="background: #e0e7ff; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #4338ca;"><strong>Valor Total:</strong></span>
                        <span id="edit_total_value_display" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #4338ca;"><strong>Valor por Parcela:</strong></span>
                        <span id="edit_installment_value" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_expense_month">MÃªs da Despesa *</label>
                    <input type="month" id="edit_expense_month" name="expense_month" required>
                    <small style="color: #666; display: block; margin-top: 5px;">Selecione o mÃªs em que a despesa foi gerada</small>
                </div>

                <div class="form-group">
                    <label for="edit_due_date">Data de Vencimento *</label>
                    <input type="date" id="edit_due_date" name="due_date" required>
                    <small style="color: #666; display: block; margin-top: 5px;">Data do pagamento (normalmente no mÃªs seguinte)</small>
                </div>

                <div class="form-group">
                    <label for="edit_category">Categoria (opcional)</label>
                    <input type="text" id="edit_category" name="category" placeholder="Ex: Moradia, AlimentaÃ§Ã£o">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('editExpenseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, description, totalAmount, installments, valueType, dueDate, category, expenseMonth) {
        document.getElementById('editExpenseForm').action = '/edit_expense/' + id;
        document.getElementById('edit_expense_description').value = description;
        document.getElementById('edit_installments').value = installments;
        document.getElementById('edit_value_type').value = valueType;
        document.getElementById('edit_due_date').value = dueDate;
        document.getElementById('edit_category').value = category || '';
        document.getElementById('edit_expense_month').value = expenseMonth || '';
        
        // Calculate the input value based on value_type
        if (installments > 1 && valueType === 'individual') {
            document.getElementById('edit_total_amount').value = (totalAmount / installments).toFixed(2);
        } else {
            document.getElementById('edit_total_amount').value = totalAmount.toFixed(2);
        }
        
        toggleEditValueTypeField();
        calculateEditInstallment();
        openModal('editExpenseModal');
    }
    
    function toggleEditValueTypeField() {
        const installments = parseInt(document.getElementById('edit_installments').value) || 1;
        const valueTypeGroup = document.getElementById('edit_value_type_group');
        const valueTypeSelect = document.getElementById('edit_value_type');
        
        if (installments > 1) {
            valueTypeGroup.style.display = 'block';
            valueTypeSelect.required = true;
        } else {
            valueTypeGroup.style.display = 'none';
            valueTypeSelect.required = false;
            valueTypeSelect.value = 'total';
        }
        
        calculateEditInstallment();
    }
    
    function calculateEditInstallment() {
        const amountInput = parseFloat(document.getElementById('edit_total_amount').value) || 0;
        const installments = parseInt(document.getElementById('edit_installments').value) || 1;
        const valueType = document.getElementById('edit_value_type').value;
        const installmentInfo = document.getElementById('edit_installment_info');
        
        if (amountInput > 0 && (installments === 1 || valueType)) {
            let totalValue, installmentValue;
            
            if (installments > 1 && valueType) {
                if (valueType === 'total') {
                    totalValue = amountInput;
                    installmentValue = amountInput / installments;
                } else if (valueType === 'individual') {
                    installmentValue = amountInput;
                    totalValue = amountInput * installments;
                }
            } else {
                totalValue = amountInput;
                installmentValue = amountInput;
            }
            
            if (totalValue !== undefined) {
                installmentInfo.style.display = 'block';
                document.getElementById('edit_total_value_display').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalValue);
                document.getElementById('edit_installment_value').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(installmentValue);
            } else {
                installmentInfo.style.display = 'none';
            }
        } else {
            installmentInfo.style.display = 'none';
        }
    }

    function toggleValueTypeField() {
        const installments = parseInt(document.getElementById('installments').value) || 1;
        const valueTypeGroup = document.getElementById('value_type_group');
        const valueTypeSelect = document.getElementById('value_type');
        
        if (installments > 1) {
            valueTypeGroup.style.display = 'block';
            valueTypeSelect.required = true;
            // Limpa a seleÃ§Ã£o para forÃ§ar usuÃ¡rio escolher
            if (valueTypeSelect.value === 'total' || valueTypeSelect.value === '') {
                valueTypeSelect.value = '';
            }
        } else {
            valueTypeGroup.style.display = 'none';
            valueTypeSelect.required = false;
            valueTypeSelect.value = 'total';
        }
        
        calculateInstallment();
    }
    
    function validateExpenseForm() {
        const installments = parseInt(document.getElementById('installments').value) || 1;
        const valueType = document.getElementById('value_type').value;
        
        // Se tiver 1 parcela, garante que value_type seja 'total'
        if (installments === 1) {
            document.getElementById('value_type').value = 'total';
            return true;
        }
        
        // Se tiver mais de 1 parcela, exige que o usuÃ¡rio escolha o tipo
        if (!valueType) {
            alert('Por favor, selecione o Tipo de Valor');
            return false;
        }
        
        // Valida: Parcelado por Semana (individual) mÃ¡ximo 4 parcelas
        if (valueType === 'individual' && installments > 4) {
            alert('Parcelado por Semana aceita no mÃ¡ximo 4 parcelas');
            return false;
        }
        
        return true;
    }
    
    function calculateInstallment() {
        const amountInput = parseFloat(document.getElementById('total_amount').value) || 0;
        const installments = parseInt(document.getElementById('installments').value) || 1;
        const valueType = document.getElementById('value_type').value;
        const installmentInfo = document.getElementById('installment_info');
        
        if (amountInput > 0 && (installments === 1 || valueType)) {
            let totalValue, installmentValue;
            
            if (installments > 1 && valueType) {
                if (valueType === 'total') {
                    totalValue = amountInput;
                    installmentValue = amountInput / installments;
                } else if (valueType === 'individual') {
                    installmentValue = amountInput;
                    totalValue = amountInput * installments;
                }
            } else {
                totalValue = amountInput;
                installmentValue = amountInput;
            }
            
            if (totalValue !== undefined) {
                installmentInfo.style.display = 'block';
                document.getElementById('total_value_display').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalValue);
                document.getElementById('installment_value').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(installmentValue);
            } else {
                installmentInfo.style.display = 'none';
            }
        } else {
            installmentInfo.style.display = 'none';
        }
    }

    // Set default date to today
    document.getElementById('due_date').valueAsDate = new Date();
    
    // Load income data when month changes in income modal
    async function loadIncomeForMonth() {
        const month = document.getElementById('income_month').value;
        if (!month) return;
        
        try {
            const response = await fetch(`/get_income/${month}`);
            const data = await response.json();
            
            if (data.description) {
                document.getElementById('income_description').value = data.description;
                document.getElementById('income_amount').value = data.amount;
            } else {
                document.getElementById('income_description').value = '';
                document.getElementById('income_amount').value = '';
            }
        } catch (error) {
            console.error('Erro ao carregar receita:', error);
        }
    }
    
    // Load income when opening modal
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
        if (modalId === 'incomeModal') {
            loadIncomeForMonth();
        }
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
</script>
{% endblock %}

