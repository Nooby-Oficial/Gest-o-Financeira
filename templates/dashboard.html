{% extends "base.html" %}

{% block title %}Dashboard - Gest√£o Financeira{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üí∞ Gest√£o Financeira</h1>
        <div>
            <span style="margin-right: 20px; color: #666;">Ol√°, {{ session.user_name }}!</span>
            <a href="{{ url_for('logout') }}" class="btn btn-small btn-danger">Sair</a>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card">
            <h3>Receita Mensal</h3>
            <div class="value value-positive">R$ {{ "%.2f"|format(summary.total_income) }}</div>
        </div>

        <div class="summary-card">
            <h3>Despesa Mensal</h3>
            <div class="value {% if summary.total_monthly_expenses <= summary.total_income %}value-warning{% else %}value-negative{% endif %}">
                R$ {{ "%.2f"|format(summary.total_monthly_expenses) }}
            </div>
        </div>

        <div class="summary-card">
            <h3>Total de Despesas</h3>
            <div class="value {% if summary.total_expenses <= summary.total_income %}value-positive{% else %}value-yellow{% endif %}">R$ {{ "%.2f"|format(summary.total_expenses) }}</div>
        </div>

        <div class="summary-card">
            <h3>Despesa Semanal</h3>
            <div class="value {% if summary.total_weekly_expenses > (summary.total_income * 0.25) %}value-warning{% else %}value-primary{% endif %}">R$ {{ "%.2f"|format(summary.total_weekly_expenses) }}</div>
        </div>

        <div class="summary-card">
            <h3>Saldo Mensal</h3>
            <div class="value {% if summary.balance >= 0 %}value-positive{% else %}value-negative{% endif %}">
                R$ {{ "%.2f"|format(summary.balance) }}
            </div>
        </div>

        <div class="summary-card">
            <h3>% Utilizado</h3>
            <div class="value value-primary">{{ summary.percentage_used }}%</div>
        </div>

        <div class="summary-card">
            <h3>% Despesas Pagas</h3>
            <div class="value value-positive">{{ summary.percentage_paid }}%</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 20px;">
        <button onclick="openModal('incomeModal')" class="btn btn-success">+ Definir Receita</button>
        <button onclick="openModal('expenseModal')" class="btn">+ Nova Despesa</button>
    </div>

    <!-- Expenses Table -->
    <div class="card">
        <h2 style="margin-bottom: 20px; color: #667eea;">Despesas</h2>
        
        {% if expenses %}
        <table>
            <thead>
                <tr>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th>Valor Total</th>
                    <th>Parcelas</th>
                    <th>Valor/M√™s</th>
                    <th>Valor/Semana</th>
                    <th>Vencimento</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.description }}</td>
                    <td>
                        {% if expense.installments > 1 %}
                            {% if expense.get('value_type') == 'individual' %}
                                Parcelado por Semana
                            {% elif expense.get('value_type') == 'total' %}
                                Parcelado por M√™s
                            {% else %}
                                Parcelado
                            {% endif %}
                        {% else %}
                            Sem Parcelas
                        {% endif %}
                    </td>
                    <td><strong>R$ {{ "%.2f"|format(expense.total_amount) }}</strong></td>
                    <td>{{ expense.installments }}x</td>
                    <td>
                        {% if expense.get('value_type') == 'individual' %}
                            R$ {{ "%.2f"|format(expense.total_amount) }}
                        {% else %}
                            R$ {{ "%.2f"|format(expense.installment_value) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if expense.get('value_type') == 'individual' %}
                            R$ {{ "%.2f"|format(expense.installment_value) }}
                        {% else %}
                            R$ {{ "%.2f"|format(expense.installment_value / 4) }}
                        {% endif %}
                    </td>
                    <td>{{ expense.due_date }}</td>
                    <td>
                        <a href="{{ url_for('toggle_status', expense_id=expense.id) }}" 
                           onclick="return confirm('Tem certeza que deseja alterar o status para {{ 'Pendente' if expense.status == 'paid' else 'Pago' }}?')">
                            <span class="status-badge status-{{ expense.status }}">
                                {{ 'Pago' if expense.status == 'paid' else 'Pendente' }}
                            </span>
                        </a>
                    </td>
                    <td>
                        <button onclick="openEditModal({{ expense.id }}, '{{ expense.description }}', {{ expense.total_amount }}, {{ expense.installments }}, '{{ expense.get('value_type', 'total') }}', '{{ expense.due_date }}', '{{ expense.category }}')" 
                                class="btn btn-small" style="margin-right: 5px;">
                            Editar
                        </button>
                        <a href="{{ url_for('delete_expense', expense_id=expense.id) }}" 
                           class="btn btn-small btn-danger"
                           onclick="return confirm('Tem certeza que deseja excluir?')">
                            Excluir
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: #999; padding: 40px 0;">
            Nenhuma despesa cadastrada.<br>
            <small>Clique em "+ Nova Despesa" para come√ßar</small>
        </p>
        {% endif %}
    </div>

    <!-- Income Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Definir Receita</h2>
                <span class="close-modal" onclick="closeModal('incomeModal')">&times;</span>
            </div>
            
            <form method="POST" action="{{ url_for('add_income') }}">
                <div class="form-group">
                    <label for="income_description">Descri√ß√£o *</label>
                    <input type="text" id="income_description" name="description" required placeholder="Ex: Sal√°rio, Freelance">
                </div>

                <div class="form-group">
                    <label for="income_amount">Valor *</label>
                    <input type="number" id="income_amount" name="amount" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="income_month">M√™s/Ano *</label>
                    <input type="month" id="income_month" name="month" required value="{{ now.strftime('%Y-%m') }}">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('incomeModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Despesa</h2>
                <span class="close-modal" onclick="closeModal('expenseModal')">&times;</span>
            </div>
            
            <form method="POST" action="{{ url_for('add_expense') }}">
                <div class="form-group">
                    <label for="expense_description">Descri√ß√£o *</label>
                    <input type="text" id="expense_description" name="description" required placeholder="Ex: Conta de luz">
                </div>

                <div class="form-group">
                    <label for="total_amount">Valor *</label>
                    <input type="number" id="total_amount" name="total_amount" step="0.01" required placeholder="0.00" oninput="calculateInstallment()">
                </div>

                <div class="form-group">
                    <label for="installments">Parcelas *</label>
                    <input type="number" id="installments" name="installments" min="1" required value="1" oninput="toggleValueTypeField()">
                </div>

                <div class="form-group" id="value_type_group" style="display: none;">
                    <label for="value_type">Tipo de Valor *</label>
                    <select id="value_type" name="value_type" required onchange="calculateInstallment()">
                        <option value="">Selecione...</option>
                        <option value="total">Valor Total (ser√° dividido)</option>
                        <option value="individual">Valor Individual (ser√° multiplicado)</option>
                    </select>
                </div>

                <div id="installment_info" style="background: #e0e7ff; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #4338ca;"><strong>Valor Total:</strong></span>
                        <span id="total_value_display" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #4338ca;"><strong>Valor por Parcela:</strong></span>
                        <span id="installment_value" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="due_date">Data de Vencimento *</label>
                    <input type="date" id="due_date" name="due_date" required>
                </div>

                <div class="form-group">
                    <label for="category">Categoria (opcional)</label>
                    <input type="text" id="category" name="category" placeholder="Ex: Moradia, Alimenta√ß√£o">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('expenseModal')">Cancelar</button>
                    <button type="submit" class="btn" style="flex: 1;">Criar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Despesa</h2>
                <span class="close-modal" onclick="closeModal('editExpenseModal')">&times;</span>
            </div>
            
            <form id="editExpenseForm" method="POST" action="">
                <div class="form-group">
                    <label for="edit_expense_description">Descri√ß√£o *</label>
                    <input type="text" id="edit_expense_description" name="description" required placeholder="Ex: Conta de luz">
                </div>

                <div class="form-group">
                    <label for="edit_total_amount">Valor *</label>
                    <input type="number" id="edit_total_amount" name="total_amount" step="0.01" required placeholder="0.00" oninput="calculateEditInstallment()">
                </div>

                <div class="form-group">
                    <label for="edit_installments">Parcelas *</label>
                    <input type="number" id="edit_installments" name="installments" min="1" required value="1" oninput="toggleEditValueTypeField()">
                </div>

                <div class="form-group" id="edit_value_type_group" style="display: none;">
                    <label for="edit_value_type">Tipo de Valor *</label>
                    <select id="edit_value_type" name="value_type" required onchange="calculateEditInstallment()">
                        <option value="">Selecione...</option>
                        <option value="total">Valor Total (ser√° dividido)</option>
                        <option value="individual">Valor Individual (ser√° multiplicado)</option>
                    </select>
                </div>

                <div id="edit_installment_info" style="background: #e0e7ff; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #4338ca;"><strong>Valor Total:</strong></span>
                        <span id="edit_total_value_display" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #4338ca;"><strong>Valor por Parcela:</strong></span>
                        <span id="edit_installment_value" style="color: #4338ca; font-weight: bold;">R$ 0,00</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_due_date">Data de Vencimento *</label>
                    <input type="date" id="edit_due_date" name="due_date" required>
                </div>

                <div class="form-group">
                    <label for="edit_category">Categoria (opcional)</label>
                    <input type="text" id="edit_category" name="category" placeholder="Ex: Moradia, Alimenta√ß√£o">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('editExpenseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, description, totalAmount, installments, valueType, dueDate, category) {
        document.getElementById('editExpenseForm').action = '/edit_expense/' + id;
        document.getElementById('edit_expense_description').value = description;
        document.getElementById('edit_installments').value = installments;
        document.getElementById('edit_value_type').value = valueType;
        document.getElementById('edit_due_date').value = dueDate;
        document.getElementById('edit_category').value = category || '';
        
        // Calculate the input value based on value_type
        if (installments > 1 && valueType === 'individual') {
            document.getElementById('edit_total_amount').value = (totalAmount / installments).toFixed(2);
        } else {
            document.getElementById('edit_total_amount').value = totalAmount.toFixed(2);
        }
        
        toggleEditValueTypeField();
        calculateEditInstallment();
        openModal('editExpenseModal');
    }
    
    function toggleEditValueTypeField() {
        const installments = parseInt(document.getElementById('edit_installments').value) || 1;
        const valueTypeGroup = document.getElementById('edit_value_type_group');
        const valueTypeSelect = document.getElementById('edit_value_type');
        
        if (installments > 1) {
            valueTypeGroup.style.display = 'block';
            valueTypeSelect.required = true;
        } else {
            valueTypeGroup.style.display = 'none';
            valueTypeSelect.required = false;
            valueTypeSelect.value = 'total';
        }
        
        calculateEditInstallment();
    }
    
    function calculateEditInstallment() {
        const amountInput = parseFloat(document.getElementById('edit_total_amount').value) || 0;
        const installments = parseInt(document.getElementById('edit_installments').value) || 1;
        const valueType = document.getElementById('edit_value_type').value;
        const installmentInfo = document.getElementById('edit_installment_info');
        
        if (amountInput > 0 && (installments === 1 || valueType)) {
            let totalValue, installmentValue;
            
            if (installments > 1 && valueType) {
                if (valueType === 'total') {
                    totalValue = amountInput;
                    installmentValue = amountInput / installments;
                } else if (valueType === 'individual') {
                    installmentValue = amountInput;
                    totalValue = amountInput * installments;
                }
            } else {
                totalValue = amountInput;
                installmentValue = amountInput;
            }
            
            if (totalValue !== undefined) {
                installmentInfo.style.display = 'block';
                document.getElementById('edit_total_value_display').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalValue);
                document.getElementById('edit_installment_value').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(installmentValue);
            } else {
                installmentInfo.style.display = 'none';
            }
        } else {
            installmentInfo.style.display = 'none';
        }
    }

    function toggleValueTypeField() {
        const installments = parseInt(document.getElementById('installments').value) || 1;
        const valueTypeGroup = document.getElementById('value_type_group');
        const valueTypeSelect = document.getElementById('value_type');
        
        if (installments > 1) {
            valueTypeGroup.style.display = 'block';
            valueTypeSelect.required = true;
        } else {
            valueTypeGroup.style.display = 'none';
            valueTypeSelect.required = false;
            valueTypeSelect.value = 'total';
        }
        
        calculateInstallment();
    }
    
    function calculateInstallment() {
        const amountInput = parseFloat(document.getElementById('total_amount').value) || 0;
        const installments = parseInt(document.getElementById('installments').value) || 1;
        const valueType = document.getElementById('value_type').value;
        const installmentInfo = document.getElementById('installment_info');
        
        if (amountInput > 0 && (installments === 1 || valueType)) {
            let totalValue, installmentValue;
            
            if (installments > 1 && valueType) {
                if (valueType === 'total') {
                    totalValue = amountInput;
                    installmentValue = amountInput / installments;
                } else if (valueType === 'individual') {
                    installmentValue = amountInput;
                    totalValue = amountInput * installments;
                }
            } else {
                totalValue = amountInput;
                installmentValue = amountInput;
            }
            
            if (totalValue !== undefined) {
                installmentInfo.style.display = 'block';
                document.getElementById('total_value_display').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalValue);
                document.getElementById('installment_value').textContent = 
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(installmentValue);
            } else {
                installmentInfo.style.display = 'none';
            }
        } else {
            installmentInfo.style.display = 'none';
        }
    }

    // Set default date to today
    document.getElementById('due_date').valueAsDate = new Date();
</script>
{% endblock %}
